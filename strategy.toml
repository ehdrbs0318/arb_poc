# =============================================================================
# Z-Score 차익거래 전략 설정
# =============================================================================
# 시뮬레이션과 라이브 모드 모두 이 파일을 사용합니다.
# 환경변수 STRATEGY_CONFIG로 경로를 지정할 수 있습니다 (기본: strategy.toml).
# "[라이브 전용]" 표시된 파라미터는 라이브 모드에서만 사용됩니다.
# 생략된 파라미터는 기본값이 적용됩니다.
# =============================================================================

[zscore]

# ---------------------------------------------------------------------------
# 전략 핵심 파라미터
# ---------------------------------------------------------------------------

# 대상 코인 목록 (auto_select=false일 때 필수)
# auto_select=true이면 초기값으로만 사용되고, 자동 재선택됨
coins = ["BTC"]

# 캔들 윈도우 크기 (분봉 기준, 1440 = 1일치)
# 가이드라인: 추정 half-life의 3~5배
window_size = 1440

# Z-Score 진입 임계값 (양수, exit_z_threshold보다 커야 함)
entry_z_threshold = 1.0

# Z-Score 청산 임계값 (0 이상)
exit_z_threshold = 0.1

# 총 자본금 (USDT, 양 거래소 합산)
total_capital_usdt = 500.0

# 코인 페어당 최대 포지션 비율 (0 < x <= 1.0)
# 실제 포지션 크기 = total_capital_usdt * max_position_ratio
max_position_ratio = 0.5

# Upbit taker 수수료율 (0.0005 = 0.05%)
upbit_taker_fee = 0.0005

# Bybit linear taker 수수료율 (0.00055 = 0.055%)
bybit_taker_fee = 0.00055

# Bybit 레버리지 배수
leverage = 1

# Bybit 유지증거금률 (0.005 = 0.5%)
bybit_mmr = 0.005

# Z-Score 계산 시 최소 표준편차 임계값
# stddev가 이 값 미만이면 Z-Score를 0으로 처리 (노이즈 방지)
min_stddev_threshold = 0.01

# 최대 동시 포지션 수 (생략 시 coins 수만큼 허용)
# max_concurrent_positions = 3

# ---------------------------------------------------------------------------
# 자동 코인 선택
# ---------------------------------------------------------------------------

# 거래량 기반 자동 코인 선택 활성화
auto_select = true

# 자동 선택 시 최대 코인 수
max_coins = 5

# 코인 재선택 주기 (분)
reselect_interval_min = 10

# 자동 선택 시 최소 1시간 거래량 (USDT)
min_volume_1h_usdt = 50000.0

# 코인 선택 시 최대 스프레드 표준편차 (0.0이면 필터 비활성화)
# auto_select=true일 때만 적용
max_spread_stddev = 0.55

# 자동 선택에서 제외할 코인 블랙리스트
blacklist = []

# ---------------------------------------------------------------------------
# 포지션 관리
# ---------------------------------------------------------------------------

# 포지션 TTL (시간, 이후 자동 분할 청산)
position_ttl_hours = 24

# TTL 초과 후 분할 청산 유예 기간 (시간, 0 초과 필수)
grace_period_hours = 4

# 같은 코인에 대한 재진입 최소 간격 (초)
entry_cooldown_sec = 10

# 오더북 캐시 최대 유효 시간 (초)
max_cache_age_sec = 5

# 최소 기대 수익률 (%, 라운딩 후 기대 수익률이 이 값 미만이면 진입 거부)
# 0.0이면 비활성화
min_expected_roi = 0.10

# 최소 포지션 크기 (USDT, qty * bybit_price가 이 값 미만이면 진입 거부)
# 0.0이면 비활성화
min_position_usdt = 0.0

# ---------------------------------------------------------------------------
# [라이브 전용] 주문 실행
# ---------------------------------------------------------------------------

# Bybit 선물 카테고리 ("linear" 또는 "inverse")
bybit_category = "linear"

# 주문 체결 대기 타임아웃 (초, 0 초과 필수)
order_timeout_sec = 5

# 주문 실패 시 재시도 횟수
max_retry_count = 2

# 주문 타입: "limit_ioc" | "limit_gtc_cancel" | "market"
#   limit_ioc: IOC 지정가 (즉시 체결, 미체결분 취소)
#   limit_gtc_cancel: GTC 지정가 후 타임아웃 시 취소
#   market: 시장가 (슬리피지 위험)
order_type = "limit_ioc"

# IOC/GTC 지정가 시 최대 슬리피지 (%, 0 이상)
# 주문 가격 = 시장가 * (1 + max_slippage_pct/100) [매수]
#            시장가 * (1 - max_slippage_pct/100) [매도]
max_slippage_pct = 0.1

# 체결 후 PnL gate 비율 (0 이상)
# 실제 체결 PnL이 수수료의 이 비율 이상이어야 포지션 유지
# 0.5 = 수수료의 50% 이상 수익이 나야 보유, 미달 시 즉시 청산
post_exec_pnl_gate_ratio = 0.5

# 비상 청산 IOC 슬리피지 단계 (%, 단계별 확대)
# 첫 번째 → 두 번째 → 세 번째 순서로 시도
emergency_wide_ioc_slippage_pct = [2.0, 3.0, 5.0]

# REST 실패 시 비상 가격 마진 (%, 양수 필수)
# 최종 fallback 주문 시 적용 (매수: +N%, 매도: -N%)
emergency_price_fallback_margin_pct = 5.0

# Dust threshold (USDT)
# 미체결 잔량이 이 값 이하면 청산 대신 adjustment_cost로 기록
max_dust_usdt = 5.0

# ---------------------------------------------------------------------------
# [라이브 전용] 리스크 관리 (Kill Switch)
# ---------------------------------------------------------------------------

# Kill switch 활성화 여부
# true: 아래 한도 초과 시 전체 거래 중단 + 모든 포지션 비상 청산
kill_switch_enabled = true

# 일일 최대 손실 (자본의 %)
max_daily_loss_pct = 10.0

# 최대 드로다운 (자본의 %, HWM 기준)
max_drawdown_pct = 5.0

# 단건 최대 손실 (자본의 %)
max_single_loss_pct = 3.0

# 일일 최대 손실 (USDT 절대값)
max_daily_loss_usdt = 50.0

# 최대 드로다운 (USDT 절대값)
max_drawdown_usdt = 25.0

# 단건 최대 손실 (USDT 절대값)
max_single_loss_usdt = 15.0

# 단일 주문 크기 상한 (USDT, 버그 방어)
max_order_size_usdt = 2000.0

# Rolling 24h 누적 손실 상한 (USDT)
max_rolling_24h_loss_usdt = 80.0

# HWM(High Water Mark) drawdown 측정 window (일)
hwm_window_days = 7

# 전체 미실현 손실 한도 (자본의 %)
max_unrealized_loss_pct = 7.0

# ---------------------------------------------------------------------------
# [라이브 전용] 환율 (USD/KRW)
# ---------------------------------------------------------------------------

# 환율 캐시 최대 수명 (분, 0 초과 필수)
# 이 시간이 지나면 Yahoo Finance에서 재조회
max_forex_age_min = 10

# 환율 급변 알림 임계치 (%, 양수 필수)
# 직전 조회 대비 이 비율 이상 변동 시 경고 로그
forex_change_alert_pct = 0.2

# 환율 급변 후 안정 대기 시간 (분)
# 급변 감지 후 이 시간 동안 신규 진입 차단
forex_stabilization_minutes = 5

# ---------------------------------------------------------------------------
# [라이브 전용] 펀딩비 (Bybit 선물)
# ---------------------------------------------------------------------------

# 정산 N분 전부터 신규 진입 차단 (0 초과 필수)
funding_block_before_min = 10

# 정산 후 N분까지 신규 진입 차단
funding_block_after_min = 0

# 정산 전 불리 포지션 강제 청산 활성화
funding_force_close_enabled = true

# Major 코인: 정산 N분 전 강제 청산
funding_force_close_minutes_major = 1

# Alt 코인: 정산 N분 전 강제 청산
funding_force_close_minutes_alt = 5

# Major 코인 목록 (정산 전 강제 청산 시간이 다름)
funding_major_coins = ["BTC", "ETH", "XRP", "SOL"]

# 펀딩비가 기대수익의 N% 초과 시 경고 (0.2 = 20%)
funding_alert_ratio = 0.2

# 펀딩비가 기대수익의 N% 초과 시 해당 코인 제외 (0.5 = 50%)
# funding_alert_ratio보다 커야 함
funding_exclude_ratio = 0.5

# ---------------------------------------------------------------------------
# [라이브 전용] 장애 복구
# ---------------------------------------------------------------------------

# PendingExchangeRecovery 최대 체류 시간 (시간)
# 한쪽 거래소만 체결된 불일치 상태의 최대 허용 시간
pending_recovery_timeout_hours = 2

# ---------------------------------------------------------------------------
# [라이브 전용] 종료 정책
# ---------------------------------------------------------------------------

# 프로세스 종료 시 포지션 처리 정책:
#   "keep"              - 포지션 유지 (DB에 기록, 재시작 시 복구)
#   "close_all"         - 모든 포지션 청산 후 종료
#   "close_if_profitable" - 수익 포지션만 청산, 손실 포지션은 유지
shutdown_policy = "keep"

# ---------------------------------------------------------------------------
# [라이브 전용] 텔레그램 알림
# ---------------------------------------------------------------------------

# 텔레그램 알림 활성화 (진입/청산/에러/kill switch 알림)
telegram_enabled = true

# =============================================================================
# 세션 출력 설정
# =============================================================================

[output]

# CSV 출력 활성화 (minutes.csv, trades.csv, session_summary.txt)
enabled = true

# 출력 디렉토리 (상대 경로 또는 절대 경로)
dir = "output"

[balance_snapshot]
# 정기 기록 주기 (초). 기본값: 600 (10분)
interval_sec = 600